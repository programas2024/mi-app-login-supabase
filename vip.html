<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 VIP Elite Rewards 🌟</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style2.css"> <!-- ¡Asegúrate de que este archivo CSS esté enlazado! -->
</head>
<body>
    <div class="vip-container">
        <!-- Sección Principal de Recompensas -->
        <main class="rewards-main-content">
            <h2 class="rewards-title">Tabla de Recompensas Elite</h2>

            <!-- Display de Balance del Usuario -->
            <div class="user-balance-display">
                <div class="balance-item">
                    <i class="fas fa-diamond diamond-icon"></i>
                    <span>Tus Diamantes:</span>
                    <span id="current-diamonds" class="balance-value">0</span>
                </div>
                <div class="balance-item">
                    <i class="fas fa-coins gold-icon"></i>
                    <span>Tu Oro:</span>
                    <span id="current-gold" class="balance-value">0</span>
                </div>
            </div>

            <div class="rewards-table-scroll">
                <table class="vip-rewards-table">
                    <thead>
                        <tr>
                            <th>Nivel VIP</th>
                            <th>Recompensa Exclusiva</th>
                            <th>Tesoro Doble (Oro + Esmeralda)</th>
                            <th>Desbloquear / Reclamar</th> <!-- Nueva columna para acciones -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas se generarán con JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- Botón para cargar más niveles -->
            <button id="load-more-levels" class="load-more-btn">Cargar Más Niveles <i class="fas fa-arrow-down"></i></button>
        </main>
    </div>

    <!-- Botón para Volver al Juego -->
    <a href="dashboard.html" class="back-to-game-btn">Volver al Juego</a>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Todo el JavaScript incrustado aquí -->
    <script type="module">
        // Importaciones necesarias para este módulo: Supabase y Confetti
        // ¡CAMBIO CLAVE AQUÍ: Usamos jsDelivr con una versión específica y estable de Supabase!
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/+esm';
        import confetti from 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/+esm';

        // --- Configuración de Supabase ---
        const SUPABASE_URL = 'https://fesrphtabjohxcklbosh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlc3JwaHRhYmpvaHhja2xib3NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjQ0ODAsImV4cCI6MjA2ODYwMDQ4MH0.S8EJGetv7v9OWfiUCbxvoza1e8yWvYCrR5nLo';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Elementos del DOM ---
        const currentDiamondsSpan = document.getElementById('current-diamonds');
        const currentGoldSpan = document.getElementById('current-gold');
        const tbody = document.querySelector('.vip-rewards-table tbody');
        const loadMoreBtn = document.getElementById('load-more-levels');

        // --- Variables de Estado del Usuario ---
        let currentUser = null;
        let userProfile = {
            gold: 0,
            diamonds: 0,
            unlocked_levels: [],
            claimed_levels: []
        };

        // --- Configuración de Niveles y Recompensas ---
        const levelsToShowInitially = 5;
        const levelsPerLoad = 3;
        let currentLoadedLevels = 0;

        const allRewardsData = [];

        // Generar TODOS los datos de las recompensas una sola vez
        for (let i = 1; i <= 20; i++) {
            let reward1 = {};
            let reward2Gold = 0;
            let reward2Emerald = 0;
            const unlockCost = 100 * i;

            if (i % 2 !== 0) {
                reward1 = { type: 'gold', amount: 100 + (i * 15) };
            } else {
                reward1 = { type: 'diamond', amount: 10 + (i * 3) };
            }

            reward2Gold = 50 + (i * 10);
            reward2Emerald = 2 + Math.floor(i / 3);

            if (i % 5 === 0) {
                reward1.amount += 25;
                reward2Gold += 50;
            }
            if (i % 10 === 0) {
                reward1.amount += 60;
                reward2Gold += 100;
                reward2Emerald += 3;
            }
            allRewardsData.push({
                level: i,
                unlockCost: unlockCost,
                reward1: reward1,
                reward2Gold: reward2Gold,
                reward2Emerald: reward2Emerald
            });
        }

        // --- Funciones de Supabase ---

        /**
         * Obtiene el perfil del usuario actual desde Supabase.
         * Si no existe, crea uno nuevo con valores por defecto.
         * @param {string} userId - El ID del usuario.
         * @returns {Object|null} El perfil del usuario o null si hay un error irrecuperable.
         */
        async function fetchUserProfile(userId) {
            let { data: profile, error } = await supabase
                .from('profiles')
                .select('gold, diamonds, unlocked_levels, claimed_levels')
                .eq('id', userId)
                .single();

            if (error) {
                console.error("Error fetching user profile:", error.message);
                if (error.code === 'PGRST116' || error.message.includes('rows returned for query')) {
                    console.log("Profile not found, creating new one.");
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert([
                            { id: userId, gold: 0, diamonds: 0, unlocked_levels: [], claimed_levels: [] }
                        ])
                        .select()
                        .single();
                    if (createError) {
                        console.error("Error creating user profile:", createError.message);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Crítico',
                            text: 'No pudimos crear tu perfil de jugador. Por favor, contacta soporte.',
                            customClass: { popup: 'swal2-custom-game-over' }
                        });
                        return null;
                    }
                    profile = newProfile;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Perfil',
                        text: 'No pudimos cargar tu perfil. Intenta recargar la página.',
                        customClass: { popup: 'swal2-custom-game-over' }
                    });
                    return null;
                }
            }
            profile.unlocked_levels = profile.unlocked_levels || [];
            profile.claimed_levels = profile.claimed_levels || [];
            return profile;
        }

        /**
         * Actualiza el perfil del usuario en Supabase.
         * @param {Object} updatedData - Un objeto con los campos a actualizar.
         * @returns {boolean} True si la actualización fue exitosa, false en caso contrario.
         */
        async function updateProfileInSupabase(updatedData) {
            const { data, error } = await supabase
                .from('profiles')
                .update(updatedData)
                .eq('id', currentUser.id);

            if (error) {
                console.error("Error updating user profile:", error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Guardar',
                    text: 'No pudimos guardar los cambios en tu perfil. Intenta de nuevo.',
                    customClass: { popup: 'swal2-custom-game-over' }
                });
                return false;
            }
            return true;
        }

        // --- Funciones de Lógica del Juego ---

        /**
         * Actualiza el display de oro y diamantes en la UI.
         */
        function updateBalanceDisplay() {
            currentDiamondsSpan.textContent = userProfile.diamonds;
            currentGoldSpan.textContent = userProfile.gold;
        }

        /**
         * Renderiza un grupo de niveles en la tabla.
         * @param {number} startIndex - Índice inicial en allRewardsData.
         * @param {number} count - Número de niveles a renderizar.
         */
        function renderLevels(startIndex, count) {
            const endIndex = Math.min(startIndex + count, allRewardsData.length);
            for (let j = startIndex; j < endIndex; j++) {
                const item = allRewardsData[j];
                const level = item.level;
                const unlockCost = item.unlockCost;

                const isUnlocked = userProfile.unlocked_levels.includes(level);
                const isClaimed = userProfile.claimed_levels.includes(level);
                const canAfford = userProfile.diamonds >= unlockCost;

                const row = tbody.insertRow();
                row.dataset.level = level;
                row.classList.toggle('level-locked', !isUnlocked && !isClaimed);

                row.insertCell().textContent = level;

                const cell1 = row.insertCell();
                cell1.classList.add('reward-item-cell');
                const iconClass1 = item.reward1.type === 'gold' ? 'fas fa-coins gold-icon' : 'fas fa-diamond diamond-icon';
                cell1.innerHTML = `<i class="${iconClass1}"></i> <span class="reward-amount-text">${item.reward1.amount}</span>`;

                const cell2 = row.insertCell();
                cell2.classList.add('reward-item-cell', 'reward-pair');
                cell2.innerHTML = `
                    <div class="reward-pair-item">
                        <i class="fas fa-coins gold-icon"></i>
                        <span class="reward-amount-text">${item.reward2Gold}</span>
                    </div>
                    <span class="separator-text">y</span>
                    <div class="reward-pair-item">
                        <i class="fas fa-gem emerald-icon"></i>
                        <span class="reward-amount-text">${item.reward2Emerald}</span>
                    </div>
                `;

                const actionCell = row.insertCell();
                actionCell.classList.add('reward-item-cell');

                if (isClaimed) {
                    actionCell.innerHTML = `<button class="claimed-btn"><i class="fas fa-check-circle"></i> Reclamado</button>`;
                } else if (isUnlocked) {
                    actionCell.innerHTML = `
                        <button class="claim-btn" data-level="${level}">
                            <i class="fas fa-gift"></i> Reclamar
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = `
                        <div class="action-buttons-container">
                            <button class="unlock-btn" data-level="${level}" ${!canAfford ? 'disabled' : ''}>
                                <i class="fas fa-lock-open"></i> Desbloquear
                            </button>
                            <span class="unlock-cost-text">
                                Costo: ${unlockCost} <i class="fas fa-diamond diamond-icon"></i>
                            </span>
                        </div>
                    `;
                }
            }
            currentLoadedLevels = endIndex;

            if (currentLoadedLevels >= allRewardsData.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'flex';
            }

            attachButtonListeners();
        }

        /**
         * Adjunta event listeners a los botones de desbloqueo y reclamo.
         * Se llama después de cada renderizado de niveles.
         */
        function attachButtonListeners() {
            tbody.querySelectorAll('.unlock-btn').forEach(button => {
                button.onclick = null;
                button.onclick = async (event) => {
                    const level = parseInt(event.currentTarget.dataset.level);
                    await handleUnlockLevel(level);
                };
            });

            tbody.querySelectorAll('.claim-btn').forEach(button => {
                button.onclick = null;
                button.onclick = async (event) => {
                    const level = parseInt(event.currentTarget.dataset.level);
                    await handleClaimReward(level);
                };
            });
        }

        /**
         * Maneja la lógica para desbloquear un nivel.
         * @param {number} level - El nivel a desbloquear.
         */
        async function handleUnlockLevel(level) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'info',
                    title: 'Necesitas Iniciar Sesión',
                    text: 'Por favor, inicia sesión para desbloquear niveles VIP.',
                    customClass: { popup: 'swal2-custom-warning' }
                });
                return;
            }

            const levelData = allRewardsData.find(item => item.level === level);
            if (!levelData) return;

            const unlockCost = levelData.unlockCost;

            if (userProfile.diamonds < unlockCost) {
                Swal.fire({
                    icon: 'error',
                    title: 'Diamantes Insuficientes',
                    text: `Necesitas ${unlockCost} diamantes para desbloquear el Nivel ${level}.`,
                    customClass: { popup: 'swal2-custom-game-over' }
                });
                return;
            }

            userProfile.diamonds -= unlockCost;
            userProfile.unlocked_levels.push(level);
            userProfile.unlocked_levels.sort((a, b) => a - b);

            const success = await updateProfileInSupabase({
                diamonds: userProfile.diamonds,
                unlocked_levels: userProfile.unlocked_levels
            });

            if (success) {
                updateBalanceDisplay();
                Swal.fire({
                    icon: 'success',
                    title: '¡Nivel Desbloqueado!',
                    text: `¡Has desbloqueado el Nivel ${level} VIP! Ahora puedes reclamar sus recompensas.`,
                    customClass: { popup: 'swal2-custom-final-success' }
                });
                updateRowStatus(level);
            }
        }

        /**
         * Maneja la lógica para reclamar las recompensas de un nivel desbloqueado.
         * @param {number} level - El nivel cuyas recompensas se van a reclamar.
         */
        async function handleClaimReward(level) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'info',
                    title: 'Necesitas Iniciar Sesión',
                    text: 'Por favor, inicia sesión para reclamar recompensas VIP.',
                    customClass: { popup: 'swal2-custom-warning' }
                });
                return;
            }

            const levelData = allRewardsData.find(item => item.level === level);
            if (!levelData) return;

            if (userProfile.claimed_levels.includes(level)) {
                Swal.fire({
                    icon: 'info',
                    title: 'Recompensa Ya Reclamada',
                    text: `Ya has reclamado las recompensas del Nivel ${level}.`,
                    customClass: { popup: 'swal2-custom-warning' }
                });
                return;
            }

            userProfile.gold += levelData.reward1.type === 'gold' ? levelData.reward1.amount : 0;
            userProfile.diamonds += levelData.reward1.type === 'diamond' ? levelData.reward1.amount : 0;
            userProfile.gold += levelData.reward2Gold;
            userProfile.diamonds += levelData.reward2Emerald;

            userProfile.claimed_levels.push(level);
            userProfile.claimed_levels.sort((a, b) => a - b);

            const success = await updateProfileInSupabase({
                gold: userProfile.gold,
                diamonds: userProfile.diamonds,
                claimed_levels: userProfile.claimed_levels
            });

            if (success) {
                updateBalanceDisplay();
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                Swal.fire({
                    icon: 'success',
                    title: '¡Recompensa Reclamada!',
                    html: `¡Has reclamado las recompensas del Nivel ${level}!<br>Disfruta de tu nuevo oro y diamantes.`,
                    customClass: { popup: 'swal2-custom-final-success' }
                });
                updateRowStatus(level);
            }
        }

        /**
         * Actualiza el estado de una fila de nivel específica en la tabla.
         * Esto evita re-renderizar toda la tabla.
         * @param {number} level - El nivel de la fila a actualizar.
         */
        function updateRowStatus(level) {
            const row = tbody.querySelector(`tr[data-level="${level}"]`);
            if (!row) return;

            const levelData = allRewardsData.find(item => item.level === level);
            if (!levelData) return;

            const isUnlocked = userProfile.unlocked_levels.includes(level);
            const isClaimed = userProfile.claimed_levels.includes(level);
            const canAfford = userProfile.diamonds >= levelData.unlockCost;

            row.classList.toggle('level-locked', !isUnlocked && !isClaimed);

            const actionCell = row.querySelector('.reward-item-cell:last-child');
            if (actionCell) {
                actionCell.innerHTML = '';

                if (isClaimed) {
                    actionCell.innerHTML = `<button class="claimed-btn"><i class="fas fa-check-circle"></i> Reclamado</button>`;
                } else if (isUnlocked) {
                    actionCell.innerHTML = `
                        <button class="claim-btn" data-level="${level}">
                            <i class="fas fa-gift"></i> Reclamar
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = `
                        <div class="action-buttons-container">
                            <button class="unlock-btn" data-level="${level}" ${!canAfford ? 'disabled' : ''}>
                                <i class="fas fa-lock-open"></i> Desbloquear
                            </button>
                            <span class="unlock-cost-text">
                                Costo: ${levelData.unlockCost} <i class="fas fa-diamond diamond-icon"></i>
                            </span>
                        </div>
                    `;
                }
                // Re-adjuntar listeners a los botones recién creados en esta fila
                const newButton = actionCell.querySelector('.unlock-btn') || actionCell.querySelector('.claim-btn');
                if (newButton) {
                    if (newButton.classList.contains('unlock-btn')) {
                        newButton.onclick = async (event) => {
                            const lvl = parseInt(event.currentTarget.dataset.level);
                            await handleUnlockLevel(lvl);
                        };
                    } else if (newButton.classList.contains('claim-btn')) {
                        newButton.onclick = async (event) => {
                            const lvl = parseInt(event.currentTarget.dataset.level);
                            await handleClaimReward(lvl);
                        };
                    }
                }
            }
        }

        // --- Inicialización y Event Listeners Globales ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Initializing Supabase auth listener.");
            console.log("Supabase client object:", supabase);
            console.log("Supabase auth object:", supabase.auth);
            console.log("Type of supabase.auth.onAuthStateChanged (before setTimeout):", typeof supabase.auth.onAuthStateChanged);
            console.log("Properties of supabase.auth (before setTimeout):", Object.keys(supabase.auth));


            // Retrasar la inicialización del listener de autenticación
            // Esto le da a Supabase un momento extra para inicializar completamente
            setTimeout(() => {
                try {
                    console.log("Inside setTimeout. Type of supabase.auth.onAuthStateChanged:", typeof supabase.auth.onAuthStateChanged);
                    console.log("Properties of supabase.auth (inside setTimeout):", Object.keys(supabase.auth));

                    if (supabase && supabase.auth && typeof supabase.auth.onAuthStateChanged === 'function') {
                        supabase.auth.onAuthStateChanged(async (event, session) => {
                            console.log("Auth state changed:", event, session);
                            if (session && session.user) {
                                currentUser = session.user;
                                console.log("Usuario autenticado:", currentUser.id);
                                userProfile = await fetchUserProfile(currentUser.id);
                                if (userProfile) {
                                    updateBalanceDisplay();
                                    tbody.innerHTML = '';
                                    currentLoadedLevels = 0;
                                    renderLevels(0, levelsToShowInitially);
                                }
                            } else {
                                currentUser = null;
                                userProfile = { gold: 0, diamonds: 0, unlocked_levels: [], claimed_levels: [] };
                                updateBalanceDisplay();
                                Swal.fire({
                                    icon: 'info',
                                    title: 'No Autenticado',
                                    text: 'Inicia sesión para ver y reclamar tus recompensas VIP. Se mostrarán los niveles, pero no podrás interactuar con ellos.',
                                    customClass: { popup: 'swal2-custom-warning' }
                                });
                                tbody.innerHTML = '';
                                currentLoadedLevels = 0;
                                renderLevels(0, levelsToShowInitially);
                            }
                        });
                    } else {
                        // Si llegamos aquí, significa que supabase.auth.onAuthStateChanged no es una función
                        throw new Error("supabase.auth o onAuthStateChanged no están disponibles como función.");
                    }
                } catch (e) {
                    console.error("Error al inicializar el listener de autenticación de Supabase:", e);
                    console.error("Detalles de depuración (dentro del catch):", {
                        supabaseExists: !!supabase,
                        supabaseAuthExists: !!supabase.auth,
                        onAuthStateChangedIsFunction: typeof (supabase && supabase.auth ? supabase.auth.onAuthStateChanged : undefined) === 'function',
                        errorMessage: e.message
                    });
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Inicialización',
                        text: 'El sistema de autenticación no pudo cargarse correctamente. Por favor, recarga la página o intenta más tarde.',
                        customClass: { popup: 'swal2-custom-game-over' }
                    });
                }
            }, 10); // Pequeño retardo de 10ms
            
            // Event listener para el botón "Cargar Más Niveles"
            loadMoreBtn.addEventListener('click', () => {
                renderLevels(currentLoadedLevels, levelsPerLoad);
            });
        });
    </script>
</body>
</html>