<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuadrón - GameHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #1f46b2, #2dc2fd);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(13, 17, 23, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #78ffd6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .currency {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .gold {
            color: gold;
        }

        .diamonds {
            color: #6ef7ff;
        }

        .btn {
            background: linear-gradient(90deg, #78ffd6, #a8ff78);
            color: #0d1117;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(120, 255, 214, 0.4);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .squad-details {
            background: rgba(30, 35, 48, 0.8);
            padding: 25px;
            border-radius: 15px;
            display: none;
        }

        .squad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .squad-name {
            font-size: 28px;
            color: #78ffd6;
        }

        .squad-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .info-label {
            display: block;
            font-size: 12px;
            color: #78ffd6;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
        }

        .members-list {
            margin-top: 20px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #78ffd6, #a8ff78);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .leader-avatar {
            background: linear-gradient(135deg, gold, #ffbb00);
        }

        .member-details {
            flex: 1;
        }

        .member-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-role {
            background: rgba(120, 255, 214, 0.2);
            color: #78ffd6;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .member-stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            color: #78ffd6;
            font-weight: bold;
        }

        .view-more {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .create-squad-container {
            background: rgba(30, 35, 48, 0.8);
            padding: 25px;
            border-radius: 15px;
        }

        .create-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .create-header h2 {
            font-size: 28px;
            color: #78ffd6;
            margin-bottom: 10px;
        }

        .create-header p {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #78ffd6;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(120, 255, 214, 0.3);
            background: rgba(13, 17, 23, 0.7);
            color: white;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #78ffd6;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .cost-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            color: gold;
        }

        .error-container {
            text-align: center;
            padding: 40px;
        }

        .error-icon {
            font-size: 60px;
            color: #ff6b6b;
            margin-bottom: 20px;
        }

        .squad-selection {
            background: rgba(30, 35, 48, 0.8);
            padding: 25px;
            border-radius: 15px;
            display: none;
        }

        .squad-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .squad-item:hover {
            background: rgba(120, 255, 214, 0.1);
        }

        .squad-item-info {
            flex: 1;
        }

        .squad-item-name {
            font-weight: bold;
            color: #78ffd6;
        }

        .squad-item-mission {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }
            
            .squad-info {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-users"></i>
                <span>GameHub Escuadrones</span>
            </div>
            <div class="user-info">
                <div class="currency gold">
                    <i class="fas fa-coins"></i>
                    <span id="gold-amount">0</span>
                </div>
                <div class="user-name">
                    Líder: <span id="leader-name">Usuario</span>
                </div>
            </div>
            <button class="btn btn-back" id="back-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
        </div>

        <!-- Contenedor de error de API -->
        <div class="error-container" id="api-error" style="display: none;">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Error de Conexión</h2>
            <p>No se pudo conectar con el servidor. Por favor, intenta nuevamente.</p>
            <button class="btn" id="retry-btn">
                <i class="fas fa-redo"></i> Reintentar
            </button>
        </div>

        <!-- Contenedor de error de RLS -->
        <div class="error-container" id="rls-error" style="display: none;">
            <div class="error-icon">
                <i class="fas fa-database"></i>
            </div>
            <h2>Error de Permisos</h2>
            <p>Necesitas configurar las políticas RLS en Supabase para que la aplicación funcione correctamente.</p>
            <button class="btn" id="fix-rls-btn">
                <i class="fas fa-tools"></i> Ver Instrucciones
            </button>
        </div>

        <!-- Contenedor de selección de escuadrón -->
        <div class="squad-selection" id="squad-selection">
            <h2>Tienes múltiples escuadrones</h2>
            <p>Selecciona el escuadrón que deseas gestionar:</p>
            <div id="squad-list"></div>
        </div>

        <div class="content">
            <!-- Detalles del escuadrón (visible solo si tiene escuadrón) -->
            <div class="squad-details" id="squad-details">
                <div class="squad-header">
                    <h2 class="squad-name" id="detail-name">Nombre del Escuadrón</h2>
                    <button class="btn" id="view-more-btn">
                        <i class="fas fa-eye"></i> Ver Más
                    </button>
                </div>

                <div class="squad-info" id="squad-info">
                    <div class="info-item">
                        <span class="info-label">MIEMBROS</span>
                        <span class="info-value" id="detail-members">0/10</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">MISIÓN</span>
                        <span class="info-value" id="detail-mission">Ser los mejores</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">RANGO</span>
                        <span class="info-value" id="detail-rank">Bronce</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">LÍDER</span>
                        <span class="info-value" id="detail-leader">Usuario</span>
                    </div>
                </div>

                <h3>Miembros del Escuadrón</h3>
                <div class="members-list" id="members-list">
                    <div class="member-item">
                        <div class="member-avatar leader-avatar">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="member-details">
                            <div class="member-name">
                                <span id="leader-username">Usuario</span>
                                <span class="member-role">Líder</span>
                            </div>
                            <div class="member-stats">
                                <span class="stat">Nivel: <span class="stat-value" id="leader-level">1</span></span>
                                <span class="stat">Puntos: <span class="stat-value" id="leader-points">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-more">
                    <button class="btn" id="view-more-button">
                        <i class="fas fa-chevron-down"></i> Ver todos los miembros
                    </button>
                </div>
            </div>

            <!-- Creación de escuadrón (visible solo si no tiene escuadrón) -->
            <div class="create-squad-container" id="create-squad-container" style="display: none;">
                <div class="create-header">
                    <h2>Crear un Nuevo Escuadrón</h2>
                    <p>Forma tu equipo y comienza a ascender en el ranking</p>
                </div>

                <div class="form-group">
                    <label for="squad-name">Nombre del Escuadrón</label>
                    <input type="text" id="squad-name" placeholder="Ej: Los Invencibles">
                </div>

                <div class="form-group">
                    <label for="squad-members">Número de Miembros</label>
                    <select id="squad-members">
                        <option value="1">1 miembro</option>
                        <option value="2">2 miembros</option>
                        <option value="3">3 miembros</option>
                        <option value="4">4 miembros</option>
                        <option value="5">5 miembros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="squad-mission">Misión Principal</label>
                    <select id="squad-mission">
                        <option value="Ser top 1">Ser top 1</option>
                        <option value="Dominar las ligas">Dominar las ligas</option>
                        <option value="Conquistar torneos">Conquistar torneos</option>
                        <option value="Completar todos los logros">Completar todos los logros</option>
                    </select>
                </div>

                <div class="cost-info">
                    <i class="fas fa-coins"></i> Costo: 200 de Oro
                </div>

                <div class="form-actions">
                    <button class="btn" id="create-squad-btn">
                        <i class="fas fa-plus"></i> Crear Escuadrón
                    </button>
                    <button class="btn btn-back" id="cancel-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>

            <!-- Mensaje cuando no tiene escuadrón -->
            <div class="create-squad-container" id="empty-squad" style="display: none;">
                <div class="create-header">
                    <h2>No tienes un escuadrón</h2>
                    <p>Crea tu propio escuadrón o únete a uno existente para comenzar</p>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <i class="fas fa-users-slash" style="font-size: 60px; color: #78ffd6; margin-bottom: 20px;"></i>
                    <p>Actualmente no perteneces a ningún escuadrón.</p>
                </div>

                <div class="form-actions">
                    <button class="btn" id="create-new-btn">
                        <i class="fas fa-plus"></i> Crear Escuadrón
                    </button>
                    <button class="btn btn-back" id="search-squads-btn">
                        <i class="fas fa-search"></i> Buscar Escuadrones
                    </button>
                </div>
            </div>
        </div>
    </div>

   <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://fesrphtabjohxcklbosh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlc3JwaHRhYmpvaHhja2xib3NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjQ0ODAsImV4cCI6MjA2ODYwMDQ4MH0.S8EJGetv7v9OWfiUCbxvoza1e8yUBVojyWvYCrR5nLo';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Variables globales
    let currentUser = null;
    let userProfile = null;
    let userSquad = null;
    let userSquads = [];
    let pendingRequests = [];
    
    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeApp();
    });
    
    // Inicializar la aplicación
    async function initializeApp() {
        hideApiError();
        hideSquadSelection();
        hideAllContainers();
        
        try {
            await checkUserStatus();
            await loadUserData();
            await checkPendingRequests(); // Verificar solicitudes primero
            await checkExistingSquads();
        } catch (error) {
            console.error('Error al inicializar la aplicación:', error);
            showApiError();
        }
    }
    
    // Ocultar todos los contenedores principales
    function hideAllContainers() {
        const squadDetails = document.getElementById('squad-details');
        const createContainer = document.getElementById('create-squad-container');
        const emptySquad = document.getElementById('empty-squad');
        const squadSelection = document.getElementById('squad-selection');
        const requestContainer = document.getElementById('request-container');
        
        if (squadDetails) squadDetails.style.display = 'none';
        if (createContainer) createContainer.style.display = 'none';
        if (emptySquad) emptySquad.style.display = 'none';
        if (squadSelection) squadSelection.style.display = 'none';
        if (requestContainer) requestContainer.style.display = 'none';
    }
    
    // Ocultar error de API
    function hideApiError() {
        const apiError = document.getElementById('api-error');
        if (apiError) apiError.style.display = 'none';
    }
    
    // Mostrar error de API
    function showApiError() {
        const apiError = document.getElementById('api-error');
        if (apiError) apiError.style.display = 'block';
    }
    
    // Ocultar selección de escuadrón
    function hideSquadSelection() {
        const squadSelection = document.getElementById('squad-selection');
        if (squadSelection) squadSelection.style.display = 'none';
    }
    
    // Mostrar selección de escuadrón
    function showSquadSelection() {
        hideAllContainers();
        const squadSelection = document.getElementById('squad-selection');
        if (squadSelection) squadSelection.style.display = 'block';
    }
    
    // Mostrar creación de escuadrón
    function showCreateSquadContainer() {
        hideAllContainers();
        const createContainer = document.getElementById('create-squad-container');
        if (createContainer) createContainer.style.display = 'block';
    }
    
    // Mostrar mensaje de no tener escuadrón
    function showEmptySquadMessage() {
        hideAllContainers();
        const emptySquad = document.getElementById('empty-squad');
        if (emptySquad) emptySquad.style.display = 'block';
    }
    
    // Mostrar detalles del escuadrón
    function showSquadDetails() {
        hideAllContainers();
        const squadDetails = document.getElementById('squad-details');
        if (squadDetails) squadDetails.style.display = 'block';
    }
    
    // Mostrar solicitudes pendientes
    function showRequests() {
        hideAllContainers();
        const requestContainer = document.getElementById('request-container');
        if (requestContainer) requestContainer.style.display = 'block';
    }
    
    // Verificar el estado del usuario
    async function checkUserStatus() {
        try {
            // Obtener la sesión actual
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Error al obtener sesión:', error);
                throw error;
            }
            
            if (!session) {
                showError('No autenticado', 'Debes iniciar sesión para acceder a esta página');
                throw new Error('No autenticado');
            }
            
            currentUser = session.user;
            console.log("Usuario actual:", currentUser.id);
        } catch (error) {
            console.error('Error al verificar estado de usuario:', error);
            throw error;
        }
    }
    
    // Cargar datos del usuario
    async function loadUserData() {
        try {
            if (!currentUser) return;
            
            // Obtener el perfil del usuario
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                console.error('Error al cargar perfil:', error);
                throw error;
            }
            
            userProfile = profile;
            const goldAmount = document.getElementById('gold-amount');
            const leaderName = document.getElementById('leader-name');
            
            if (goldAmount) goldAmount.textContent = profile.gold.toLocaleString();
            if (leaderName) leaderName.textContent = profile.username || 'Usuario';
            
        } catch (error) {
            console.error('Error al cargar datos del usuario:', error);
            throw error;
        }
    }
    
    // Verificar si el usuario tiene solicitudes pendientes
    async function checkPendingRequests() {
        try {
            if (!currentUser) return;
            
            // Buscar solicitudes pendientes para este usuario
            const { data: requests, error } = await supabase
                .from('squad_requests')
                .select(`
                    *,
                    squads (*),
                    profiles:requested_by (username)
                `)
                .eq('user_id', currentUser.id)
                .eq('status', 'pending');
            
            if (error) {
                console.error('Error al verificar solicitudes:', error);
                return;
            }
            
            if (requests && requests.length > 0) {
                pendingRequests = requests;
                showRequests();
                displayRequests(requests);
            }
        } catch (error) {
            console.error('Error al verificar solicitudes:', error);
        }
    }
    
    // Mostrar solicitudes pendientes
    function displayRequests(requests) {
        const requestsList = document.getElementById('requests-list');
        requestsList.innerHTML = '';
        
        requests.forEach(request => {
            const requestItem = document.createElement('div');
            requestItem.className = 'request-item';
            requestItem.innerHTML = `
                <div class="request-info">
                    <h3>Invitación a: ${request.squads.name}</h3>
                    <p>Invitado por: ${request.profiles.username}</p>
                    <p>Misión: ${request.squads.mission}</p>
                    <p>Miembros: ${request.squads.member_count}/${request.squads.max_members}</p>
                    <p>Rango: ${request.squads.rank}</p>
                </div>
                <div class="request-actions">
                    <button class="btn-accept" data-id="${request.id}" data-squad-id="${request.squad_id}">Aceptar</button>
                    <button class="btn-reject" data-id="${request.id}">Rechazar</button>
                </div>
            `;
            
            requestsList.appendChild(requestItem);
        });
        
        // Agregar event listeners a los botones
        document.querySelectorAll('.btn-accept').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const requestId = e.target.getAttribute('data-id');
                const squadId = e.target.getAttribute('data-squad-id');
                await acceptRequest(requestId, squadId);
            });
        });
        
        document.querySelectorAll('.btn-reject').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const requestId = e.target.getAttribute('data-id');
                await rejectRequest(requestId);
            });
        });
    }
    
    // Aceptar una solicitud
    async function acceptRequest(requestId, squadId) {
        try {
            // 1. Actualizar el estado de la solicitud a "accepted"
            const { error: updateError } = await supabase
                .from('squad_requests')
                .update({ 
                    status: 'accepted',
                    updated_at: new Date().toISOString()
                })
                .eq('id', requestId);
            
            if (updateError) {
                console.error('Error al aceptar solicitud:', updateError);
                throw new Error('No se pudo aceptar la solicitud');
            }
            
            // 2. Obtener los datos del escuadrón
            const { data: squad, error: squadError } = await supabase
                .from('squads')
                .select('*')
                .eq('id', squadId)
                .single();
            
            if (squadError) {
                console.error('Error al obtener datos del escuadrón:', squadError);
                throw new Error('No se pudo cargar el escuadrón');
            }
            
            // 3. Actualizar el perfil del usuario para vincularlo al escuadrón
            const { error: profileError } = await supabase
                .from('profiles')
                .update({ squad_id: squadId })
                .eq('id', currentUser.id);
            
            if (profileError) {
                console.error('Error al actualizar perfil:', profileError);
                throw new Error('No se pudo unir al escuadrón');
            }
            
            // 4. Incrementar el contador de miembros del escuadrón
            const newMemberCount = squad.member_count + 1;
            const { error: squadUpdateError } = await supabase
                .from('squads')
                .update({ member_count: newMemberCount })
                .eq('id', squadId);
            
            if (squadUpdateError) {
                console.error('Error al actualizar contador de miembros:', squadUpdateError);
                throw new Error('No se pudo actualizar el escuadrón');
            }
            
            // 5. Actualizar la UI con el escuadrón
            userSquad = { ...squad, member_count: newMemberCount };
            displaySquadData(userSquad);
            showSquadDetails();
            
            // Mostrar mensaje de éxito
            Swal.fire({
                title: '¡Solicitud Aceptada!',
                text: `Te has unido al escuadrón ${squad.name}`,
                icon: 'success',
                confirmButtonColor: '#78ffd6',
                confirmButtonText: '¡Continuar!',
                background: '#1e3a47',
                color: 'white'
            });
            
        } catch (error) {
            console.error('Error al aceptar solicitud:', error);
            showError('Error', error.message || 'No se pudo aceptar la solicitud. Intenta nuevamente.');
        }
    }
    
    // Rechazar una solicitud
    async function rejectRequest(requestId) {
        try {
            const { error } = await supabase
                .from('squad_requests')
                .update({ 
                    status: 'rejected',
                    updated_at: new Date().toISOString()
                })
                .eq('id', requestId);
            
            if (error) {
                console.error('Error al rechazar solicitud:', error);
                throw new Error('No se pudo rechazar la solicitud');
            }
            
            // Recargar la lista de solicitudes
            await checkPendingRequests();
            
            // Si no hay más solicitudes, mostrar la vista normal
            if (pendingRequests.length === 0) {
                await checkExistingSquads();
            }
            
        } catch (error) {
            console.error('Error al rechazar solicitud:', error);
            showError('Error', error.message || 'No se pudo rechazar la solicitud. Intenta nuevamente.');
        }
    }
    
    // Verificar si el usuario ya tiene escuadrones
    async function checkExistingSquads() {
        try {
            if (!currentUser) return;
            
            console.log("Buscando escuadrones para el líder:", currentUser.id);
            
            // Buscar TODOS los escuadrones del usuario
            const { data: squads, error } = await supabase
                .from('squads')
                .select('*')
                .eq('leader_id', currentUser.id);
            
            if (error) {
                console.error('Error al verificar escuadrones:', error);
                // Mostrar error de RLS si es un error de permisos
                if (error.code === '42501' || error.message.includes('permission')) {
                    showRLSError();
                }
                throw error;
            }
            
            console.log("Resultado de la consulta de escuadrones:", squads);
            
            if (squads && squads.length > 0) {
                userSquads = squads;
                
                if (squads.length === 1) {
                    // Si solo tiene un escuadrón, mostrarlo directamente
                    userSquad = squads[0];
                    displaySquadData(userSquad);
                    showSquadDetails();
                } else {
                    // Si tiene múltiples escuadrones, mostrar selector
                    showSquadSelection();
                    displaySquadList(squads);
                }
            } else {
                console.log('El usuario no tiene escuadrones');
                showEmptySquadMessage();
            }
        } catch (error) {
            console.error('Error al verificar escuadrones:', error);
            throw error;
        }
    }
    
    // Mostrar lista de escuadrones para selección
    function displaySquadList(squads) {
        const squadList = document.getElementById('squad-list');
        squadList.innerHTML = '';
        
        squads.forEach(squad => {
            const squadItem = document.createElement('div');
            squadItem.className = 'squad-item';
            squadItem.innerHTML = `
                <div class="squad-item-info">
                    <div class="squad-item-name">${squad.name}</div>
                    <div class="squad-item-mission">${squad.mission} - ${squad.member_count}/${squad.max_members} miembros</div>
                </div>
                <div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
            
            squadItem.addEventListener('click', () => {
                userSquad = squad;
                displaySquadData(squad);
                showSquadDetails();
            });
            
            squadList.appendChild(squadItem);
        });
    }
    
    // Mostrar datos del escuadrón
    function displaySquadData(squad) {
        // Actualizar los detalles del escuadrón
        const detailName = document.getElementById('detail-name');
        const detailMembers = document.getElementById('detail-members');
        const detailMission = document.getElementById('detail-mission');
        const detailRank = document.getElementById('detail-rank');
        const detailLeader = document.getElementById('detail-leader');
        
        if (detailName) detailName.textContent = squad.name;
        if (detailMembers) detailMembers.textContent = `${squad.member_count}/${squad.max_members}`;
        if (detailMission) detailMission.textContent = squad.mission;
        if (detailRank) detailRank.textContent = squad.rank;
        if (detailLeader && userProfile) detailLeader.textContent = userProfile.username;
        
        // Actualizar información del líder en la lista de miembros
        const leaderUsername = document.getElementById('leader-username');
        const leaderLevel = document.getElementById('leader-level');
        const leaderPoints = document.getElementById('leader-points');
        
        if (leaderUsername) leaderUsername.textContent = userProfile.username;
        if (leaderLevel) leaderLevel.textContent = userProfile.level || 1;
        if (leaderPoints) leaderPoints.textContent = userProfile.points || 0;
    }
    
    // Mostrar error de RLS
    function showRLSError() {
        const rlsError = document.getElementById('rls-error');
        if (rlsError) rlsError.style.display = 'block';
    }
    
    // Mostrar error genérico
    function showError(title, message) {
        Swal.fire({
            title: title,
            text: message,
            icon: 'error',
            confirmButtonColor: '#78ffd6',
            confirmButtonText: 'Entendido',
            background: '#1e3a47',
            color: 'white'
        });
    }
    
    // Botón para mostrar instrucciones de RLS
    document.getElementById('fix-rls-btn').addEventListener('click', function() {
        Swal.fire({
            title: 'Configurar Políticas RLS',
            html: `
                <div style="text-align:left;">
                    <p>Para solucionar el error, ejecuta este SQL en el Editor SQL de Supabase:</p>
                    <pre style="background: #1e3a47; padding: 15px; border-radius: 8px; overflow: auto; color: white; font-size: 12px;">
-- Políticas para la tabla 'profiles'
CREATE POLICY "Users can view own profile" ON profiles
FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
FOR UPDATE USING (auth.uid() = id);

-- Políticas para la tabla 'squads'  
CREATE POLICY "Anyone can view squads" ON squads
FOR SELECT USING (true);

CREATE POLICY "Authenticated users can create squads" ON squads
FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Users can update own squads" ON squads
FOR UPDATE USING (auth.uid() = leader_id);

-- Políticas para la tabla 'squad_requests'
CREATE POLICY "Users can view their requests" ON squad_requests
FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update their requests" ON squad_requests
FOR UPDATE USING (auth.uid() = user_id);
                    </pre>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Entendido',
            width: '800px'
        });
    });
    
    // Botón Volver
    document.getElementById('back-btn').addEventListener('click', function() {
        window.location.href = 'dashboard.html';
    });
    
    // Botón Reintentar
    document.getElementById('retry-btn').addEventListener('click', function() {
        initializeApp();
    });
    
    // Botón Crear Nuevo desde mensaje vacío
    document.getElementById('create-new-btn').addEventListener('click', function() {
        showCreateSquadContainer();
    });
    
    // Botón Buscar Escuadrones
    document.getElementById('search-squads-btn').addEventListener('click', function() {
        alert('Función de búsqueda de escuadrones en desarrollo');
    });
    
    // Botón Ver Más (en el header del escuadrón)
    document.getElementById('view-more-btn').addEventListener('click', function() {
        window.location.href = 'equipo.html';
    });
    
    // Botón Ver Más (en la parte inferior)
    document.getElementById('view-more-button').addEventListener('click', function() {
        window.location.href = 'equipo.html';
    });
    
    // Botón para ignorar solicitudes
    document.getElementById('ignore-requests-btn').addEventListener('click', function() {
        showEmptySquadMessage();
    });
    
    // Crear escuadrón
    document.getElementById('create-squad-btn').addEventListener('click', async function() {
        const name = document.getElementById('squad-name').value;
        const members = document.getElementById('squad-members').value;
        const mission = document.getElementById('squad-mission').value;
        
        if (!name || !members || !mission) {
            showError('Campos incompletos', 'Por favor completa todos los campos');
            return;
        }
        
        // Verificar si tiene suficiente oro
        if (userProfile.gold < 200) {
            showError('Oro insuficiente', 'Necesitas 200 oro para crear un escuadrón');
            return;
        }
        
        try {
            // 1. Restar el oro al usuario en la tabla profiles
            const newGold = userProfile.gold - 200;
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ gold: newGold })
                .eq('id', currentUser.id);
            
            if (updateError) {
                console.error('Error al actualizar oro:', updateError);
                throw new Error('No se pudo actualizar el oro');
            }
            
            // 2. Insertar el nuevo escuadrón en la tabla de squads
            const squadData = {
                name: name,
                member_count: parseInt(members),
                max_members: 10,
                mission: mission,
                rank: 'Bronce',
                leader_id: currentUser.id,
                created_at: new Date().toISOString(),
                level: 2,
                total_points: 0
            };
            
            const { data: newSquad, error: insertError } = await supabase
                .from('squads')
                .insert([squadData])
                .select()
                .single();
            
            if (insertError) {
                console.error('Error al crear escuadrón:', insertError);
                throw new Error('No se pudo crear el escuadrón');
            }
            
            // Actualizar la UI
            userProfile.gold = newGold;
            userSquad = newSquad;
            
            const goldAmount = document.getElementById('gold-amount');
            if (goldAmount) goldAmount.textContent = newGold.toLocaleString();
            
            displaySquadData(newSquad);
            showSquadDetails();
            
            // Mostrar confeti
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            Swal.fire({
                title: '¡Escuadrón Creado!',
                html: `
                    <div style="text-align:left; margin:20px 0;">
                        <p style="margin-bottom:10px;"><strong>Nombre:</strong> ${name}</p>
                        <p style="margin-bottom:10px;"><strong>Miembros:</strong> ${members}</p>
                        <p style="margin-bottom:10px;"><strong>Misión:</strong> ${mission}</p>
                        <p style="margin-bottom:10px;"><strong>Rango:</strong> <span style="color:#cd7f32;">Bronce</span></p>
                        <p style="margin-bottom:10px;"><strong>Costo:</strong> <span style="color:gold;">200 Oro</span></p>
                    </div>
                `,
                icon: 'success',
                confirmButtonColor: '#78ffd6',
                confirmButtonText: '¡Empezar!',
                background: '#1e3a47',
                color: 'white'
            });
            
        } catch (error) {
            console.error('Error al crear escuadrón:', error);
            showError('Error', error.message || 'No se pudo crear el escuadrón. Intenta nuevamente.');
        }
    });
    
    // Botón Cancelar
    document.getElementById('cancel-btn').addEventListener('click', function() {
        document.getElementById('squad-name').value = '';
        document.getElementById('squad-members').value = '1';
        document.getElementById('squad-mission').selectedIndex = 0;
        showEmptySquadMessage();
    });
</script>
</body>
</html>