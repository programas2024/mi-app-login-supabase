<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinidad - Mi Juego</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>

        /* Botón de regreso */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #f39c12; /* Naranja brillante */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .affinity-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .affinity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .affinity-progress {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #f6ad55, #f687b3);
        }
        .friend-row {
            transition: background-color 0.2s;
        }
        .friend-row:hover {
            background-color: #f3f4f6;
        }
        .action-btn {
            transition: all 0.2s ease;
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sección izquierda - Afinidad -->
            <div class="w-full lg:w-1/3 bg-white rounded-xl shadow-md p-6">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-purple-700 mb-2">Afinidad</h1>
                    <p class="text-gray-600">Tu conexión especial con amigos</p>
                <div class="games-container">
        <button class="back-button" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </button>
                </div>

                <div id="active-affinity" class="mb-8">
                    <div id="no-active-affinity" class="text-center py-8 bg-gray-50 rounded-lg">
                        <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Selecciona un amigo para ver vuestra afinidad</p>
                    </div>
                    <div id="affinity-card-container" class="hidden"></div>
                </div>

                <div id="invite-section" class="text-center">
                    <button id="invite-friend-btn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-full shadow-lg hover:shadow-xl transition-all">
                        <i class="fas fa-user-plus mr-2"></i> Invitar Amigo
                    </button>
                </div>
            </div>

            <!-- Sección derecha - Lista de amigos -->
            <div class="w-full lg:w-2/3">
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800">Mis Amigos</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amigo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="friends-list" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i> Cargando amigos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Configuración de Supabase
        const SUPABASE_URL = 'https://fesrphtabjohxcklbosh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlc3JwaHRhYmpvaHhja2xib3NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjQ0ODAsImV4cCI6MjA2ODYwMDQ4MH0.S8EJGetv7v9OWfiUCbxvoza1e8yUBVojyWvYCrR5nLo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUserId = null;

        function getAffinityLevel(points) {
            if (points >= 500) return { level: "Confidentes", color: "bg-purple-500", icon: "fas fa-handshake" };
            if (points >= 100) return { level: "Amigos", color: "bg-pink-500", icon: "fas fa-heart" };
            return { level: "Conocidos", color: "bg-blue-500", icon: "fas fa-user-friends" };
        }

        function calculateReward(points) {
            if (points < 100) return 0; // No hay recompensa si tiene menos de 100 puntos
            if (points >= 400) return 800;
            if (points >= 200) return 500;
            if (points >= 100) return 300;
            return 0;
        }

        async function loadFriendsList() {
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            if (authError || !user) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUserId = user.id;
            
            try {
                const { data: friends, error } = await supabase
                    .from('friends')
                    .select(`
                        *,
                        user1_profile:profiles!friends_user1_id_fkey(id, username, avatar_url),
                        user2_profile:profiles!friends_user2_id_fkey(id, username, avatar_url)
                    `)
                    .or(`user1_id.eq.${user.id},user2_id.eq.${user.id}`);

                if (error) throw error;

                const friendsList = document.getElementById('friends-list');
                friendsList.innerHTML = '';

                if (friends.length === 0) {
                    friendsList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                No tienes amigos aún. ¡Invita a alguien!
                            </td>
                        </tr>
                    `;
                    return;
                }

                friends.forEach(friendship => {
                    const isUser1 = friendship.user1_id === user.id;
                    const friend = isUser1 ? friendship.user2_profile : friendship.user1_profile;
                    const affinityPoints = friendship.affinity_points || 0;
                    const affinityLevel = getAffinityLevel(affinityPoints);
                    const rewardClaimed = friendship.reward_claimed || false;
                    const lastIncrease = friendship.last_increase ? new Date(friendship.last_increase) : null;
                    const now = new Date();
                    const hoursSinceLastIncrease = lastIncrease ? (now - lastIncrease) / (1000 * 60 * 60) : 6;
                    const canIncrease = hoursSinceLastIncrease >= 6;
                    const showClaimButton = affinityPoints >= 100 && !rewardClaimed;

                    const row = document.createElement('tr');
                    row.className = 'friend-row';
                    row.dataset.friendId = friend.id;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full" src="${friend.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(friend.username)}" alt="${friend.username}">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${friend.username}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${affinityLevel.color} text-white">
                                <i class="${affinityLevel.icon} mr-1"></i> ${affinityLevel.level}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${affinityPoints} pts</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="view-affinity-btn text-purple-600 hover:text-purple-900 mr-4" data-friend-id="${friend.id}" data-friend-name="${friend.username}">
                                <i class="fas fa-eye mr-1"></i> Ver
                            </button>
                            <button class="action-btn ${showClaimButton ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'} text-white px-3 py-1 rounded" 
                                    data-friend-id="${friend.id}" ${!canIncrease ? 'disabled' : ''}>
                                <i class="fas ${showClaimButton ? 'fa-gift' : 'fa-heart'} mr-1"></i> 
                                ${showClaimButton ? 
                                    'Reclamar' : 
                                    (canIncrease ? 'Aumentar' : `${Math.ceil(6 - hoursSinceLastIncrease)}h`)}
                            </button>
                        </td>
                    `;
                    friendsList.appendChild(row);
                });

                // Delegación de eventos
                document.getElementById('friends-list').addEventListener('click', (e) => {
                    if (e.target.closest('.view-affinity-btn')) {
                        const btn = e.target.closest('.view-affinity-btn');
                        showFriendAffinity(btn.dataset.friendId, btn.dataset.friendName);
                    }
                    if (e.target.closest('.action-btn')) {
                        const btn = e.target.closest('.action-btn');
                        if (!btn.disabled) {
                            handleFriendAction(btn.dataset.friendId);
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading friends:', error);
                Swal.fire('Error', 'No se pudo cargar la lista de amigos', 'error');
            }
        }

        async function showFriendAffinity(friendId, friendName) {
            try {
                const noActiveAffinity = document.getElementById('no-active-affinity');
                const affinityCardContainer = document.getElementById('affinity-card-container');
                
                if (!noActiveAffinity || !affinityCardContainer) {
                    console.error('Elementos del DOM no encontrados');
                    return;
                }

                // Obtener datos de afinidad
                const [user1, user2] = currentUserId < friendId 
                    ? [currentUserId, friendId] 
                    : [friendId, currentUserId];

                const { data: friendship, error } = await supabase
                    .from('friends')
                    .select('affinity_points, reward_claimed, last_increase')
                    .eq('user1_id', user1)
                    .eq('user2_id', user2)
                    .single();

                if (error) throw error;
                
                if (!friendship) {
                    noActiveAffinity.classList.remove('hidden');
                    affinityCardContainer.classList.add('hidden');
                    return;
                }

                const affinityPoints = friendship.affinity_points || 0;
                const affinityLevel = getAffinityLevel(affinityPoints);
                const progressPercent = Math.min(100, (affinityPoints / 500) * 100);
                const reward = calculateReward(affinityPoints);
                const rewardClaimed = friendship.reward_claimed || false;
                const lastIncrease = friendship.last_increase ? new Date(friendship.last_increase) : null;
                const now = new Date();
                const hoursSinceLastIncrease = lastIncrease ? (now - lastIncrease) / (1000 * 60 * 60) : 6;
                const canIncrease = hoursSinceLastIncrease >= 6;
                const showClaimButton = affinityPoints >= 100 && !rewardClaimed;

                // Construir el HTML de la tarjeta de afinidad
                affinityCardContainer.innerHTML = `
                    <div class="affinity-card bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 h-16 w-16">
                                <img class="h-16 w-16 rounded-full" src="https://ui-avatars.com/api/?name=${encodeURIComponent(friendName)}&background=random" alt="${friendName}">
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">${friendName}</h3>
                                <p class="text-sm text-gray-500">${affinityLevel.level}</p>
                            </div>
                        </div>
                        
                        <div class="mb-2 flex justify-between">
                            <span class="text-sm font-medium text-gray-700">${affinityPoints} puntos</span>
                            <span class="text-sm font-medium text-gray-700">${500 - affinityPoints} para próximo nivel</span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                            <div class="affinity-progress h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        
                        <div class="text-center mb-4">
                            <h4 class="font-semibold text-gray-700">${showClaimButton ? 'Recompensa disponible' : 'Aumentar afinidad'}</h4>
                            ${!showClaimButton ? '<p class="text-sm text-gray-500">Puedes aumentar +1 punto cada 6 horas</p>' : ''}
                        </div>
                        
                        <button id="friend-action-btn" class="w-full action-btn ${showClaimButton ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded-lg" 
                                ${!canIncrease ? 'disabled' : ''}>
                            <i class="fas ${showClaimButton ? 'fa-gift' : 'fa-heart'} mr-2"></i>
                            ${showClaimButton ? 
                                (reward > 0 ? `Reclamar ${reward} oro` : 'No hay recompensa') : 
                                (canIncrease ? 'Aumentar afinidad (+1)' : `Próximo aumento en ${Math.ceil(6 - hoursSinceLastIncrease)}h`)}
                        </button>
                    </div>
                `;

                noActiveAffinity.classList.add('hidden');
                affinityCardContainer.classList.remove('hidden');

                // Añadir evento al botón de acción
                document.getElementById('friend-action-btn')?.addEventListener('click', () => {
                    handleFriendAction(friendId);
                });

            } catch (error) {
                console.error('Error al mostrar afinidad:', error);
                Swal.fire('Error', 'No se pudo cargar la afinidad con este amigo', 'error');
            }
        }

        async function handleFriendAction(friendId) {
            try {
                const [user1, user2] = currentUserId < friendId 
                    ? [currentUserId, friendId] 
                    : [friendId, currentUserId];

                // Obtener datos actuales de la amistad
                const { data: friendship, error: getError } = await supabase
                    .from('friends')
                    .select('affinity_points, reward_claimed, last_increase')
                    .eq('user1_id', user1)
                    .eq('user2_id', user2)
                    .single();

                if (getError) throw getError;
                if (!friendship) throw new Error('No se encontró la relación de amistad');

                const affinityPoints = friendship.affinity_points || 0;
                const reward = calculateReward(affinityPoints);
                const rewardClaimed = friendship.reward_claimed || false;
                const lastIncrease = friendship.last_increase ? new Date(friendship.last_increase) : null;
                const now = new Date();

                if (affinityPoints >= 100 && !rewardClaimed) {
                    // Lógica para reclamar recompensa
                    const { isConfirmed } = await Swal.fire({
                        title: '¿Reclamar recompensa?',
                        html: `Recibirás <strong>${reward} oro</strong> por tu amistad`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: '¡Sí, reclamar!',
                        cancelButtonText: 'Cancelar'
                    });

                    if (!isConfirmed) return;

                    // Obtener gold actual
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('gold')
                        .eq('id', currentUserId)
                        .single();

                    if (profileError) throw profileError;

                    // Actualizar gold y marcar recompensa como reclamada
                    const newGold = (profile.gold || 0) + reward;
                    
                    const { error: updateError } = await supabase
                        .from('friends')
                        .update({ 
                            reward_claimed: true,
                            last_increase: now.toISOString()
                        })
                        .eq('user1_id', user1)
                        .eq('user2_id', user2);

                    if (updateError) throw updateError;

                    await supabase
                        .from('profiles')
                        .update({ gold: newGold })
                        .eq('id', currentUserId);

                    await Swal.fire({
                        icon: 'success',
                        title: '¡Recompensa reclamada!',
                        html: `Has recibido <strong>${reward} oro</strong><br>Total: <strong>${newGold} oro</strong>`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    // Lógica para aumentar afinidad (+1 punto)
                    const hoursSinceLastIncrease = lastIncrease ? (now - lastIncrease) / (1000 * 60 * 60) : 6;

                    if (hoursSinceLastIncrease < 6) {
                        throw new Error(`Podrás aumentar la afinidad nuevamente en ${Math.ceil(6 - hoursSinceLastIncrease)} horas`);
                    }

                    const { error: increaseError } = await supabase
                        .from('friends')
                        .update({ 
                            affinity_points: affinityPoints + 1,
                            last_increase: now.toISOString()
                        })
                        .eq('user1_id', user1)
                        .eq('user2_id', user2);

                    if (increaseError) throw increaseError;

                    await Swal.fire({
                        icon: 'success',
                        title: '¡Afinidad aumentada!',
                        html: `+1 punto de afinidad con este amigo<br>Total: <strong>${affinityPoints + 1} pts</strong>`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                }

                // Actualizar la interfaz
                await loadFriendsList();
                const activeFriend = document.querySelector(`[data-friend-id="${friendId}"] .view-affinity-btn`);
                if (activeFriend) {
                    await showFriendAffinity(friendId, activeFriend.dataset.friendName);
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    timer: 3000
                });
            }
        }

        async function inviteFriend() {
            const { value: email } = await Swal.fire({
                title: 'Invitar amigo',
                input: 'email',
                inputLabel: 'Correo electrónico del amigo',
                inputPlaceholder: 'ejemplo@correo.com',
                showCancelButton: true,
                confirmButtonText: 'Enviar invitación',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value) return '¡Necesitas ingresar un correo!';
                    if (!/^\S+@\S+\.\S+$/.test(value)) return 'Ingresa un correo válido';
                }
            });

            if (email) {
                try {
                    const { data: userToInvite, error: userError } = await supabase
                        .from('profiles')
                        .select('id, username')
                        .ilike('email', email)
                        .single();

                    if (userError || !userToInvite) {
                        throw new Error('Usuario no encontrado');
                    }

                    const [user1, user2] = currentUserId < userToInvite.id 
                        ? [currentUserId, userToInvite.id] 
                        : [userToInvite.id, currentUserId];

                    const { data: existingFriendship, error: friendshipError } = await supabase
                        .from('friends')
                        .select('*')
                        .eq('user1_id', user1)
                        .eq('user2_id', user2)
                        .maybeSingle();

                    if (friendshipError) throw friendshipError;
                    if (existingFriendship) {
                        throw new Error('Ya son amigos');
                    }

                    const { error: inviteError } = await supabase
                        .from('friend_requests')
                        .insert([{
                            sender_id: currentUserId,
                            receiver_id: userToInvite.id,
                            status: 'pending'
                        }]);

                    if (inviteError) throw inviteError;

                    Swal.fire({
                        icon: 'success',
                        title: 'Invitación enviada',
                        text: `Se ha enviado una solicitud de amistad a ${userToInvite.username}`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                    loadFriendsList();
                } catch (error) {
                    console.error('Error inviting friend:', error);
                    Swal.fire('Error', error.message || 'No se pudo enviar la invitación', 'error');
                }
            }
        }

        // Inicializar la página
        loadFriendsList();
        
        document.getElementById('invite-friend-btn')?.addEventListener('click', inviteFriend);
    });
    </script>
</body>
</html>