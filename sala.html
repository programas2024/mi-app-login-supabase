<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Amigos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos CSS anteriores (se mantienen igual) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            gap: 20px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .back-button i {
            margin-right: 8px;
        }

        .page-title {
            font-size: 2.8rem;
            font-weight: 700;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 1.2rem;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .page-subtitle {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .room-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .users-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .user-name {
            font-size: 1.4rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .user-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .status-online {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-away {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }

        .status-busy {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .empty-room {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            padding: 20px;
        }

        .empty-room-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-room-text {
            font-size: 1.1rem;
            opacity: 0.7;
        }

        .friends-table-container {
            background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .friends-table-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .friends-table {
            width: 100%;
            border-collapse: collapse;
            flex-grow: 1;
        }

        .friends-table th {
            text-align: left;
            padding: 15px 12px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .friends-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .friends-table tr:last-child td {
            border-bottom: none;
        }

        .friends-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .friend-name {
            font-weight: 500;
        }

        .friend-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-online-indicator {
            background: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }

        .status-away-indicator {
            background: #f1c40f;
            box-shadow: 0 0 8px #f1c40f;
        }

        .status-offline-indicator {
            background: #95a5a6;
        }

        .invite-btn {
            padding: 8px 12px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .invite-online {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        .invite-online:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4);
        }

        .invite-offline {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .debug-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .room-content {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .friends-table-container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header {
                grid-template-columns: 1fr;
                justify-items: center;
                gap: 15px;
            }
            
            .users-container {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 2.2rem;
            }
            
            .friends-table th, 
            .friends-table td {
                padding: 10px 8px;
            }
            
            .invite-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 1.8rem;
            }
            
            .user-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
            
            .user-name {
                font-size: 1.2rem;
            }
            
            .friends-table {
                font-size: 0.9rem;
            }
            
            .friends-table-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
            
            <h1 class="page-title">Sala de Amigos</h1>
            
            <div>
                <button class="action-btn" onclick="showRoomInfo()">
                    <i class="fas fa-info"></i>
                </button>
                <button class="refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <p class="page-subtitle">Conecta con tus amigos y disfruten juntos de una experiencia de juego única</p>
        
        <div id="errorContainer"></div>
        
        <div class="room-content">
            <div class="users-container">
                <!-- Usuario actual -->
                <div class="user-card" id="current-user-card">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="user-name">Tú</h3>
                    <div class="user-status status-online">Conectado</div>
                    <p>Esperando amigos...</p>
                </div>
                
                <!-- Espacio para invitado -->
                <div class="user-card" id="guest-user-card">
                    <div class="empty-room">
                        <div class="empty-room-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="empty-room-text">
                            Invita a un amigo para jugar juntos
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="friends-table-container" id="friends-container">
                <h3 class="friends-table-title">Friends</h3>
                <div class="loading" id="friends-loading">
                    <div class="loading-spinner"></div>
                    <span>Cargando amigos...</span>
                </div>
            </div>
        </div>

        <button class="debug-toggle" onclick="toggleDebug()">Mostrar información de depuración</button>
        <div class="debug-info" id="debugInfo">
            <h4>Información de depuración:</h4>
            <p id="debugContent">Cargando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://fesrphtabjohxcklbosh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlc3JwaHRhYmpvaHhja2xib3NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjQ0ODAsImV4cCI6MjA2ODYwMDQ4MH0.S8EJGetv7v9OWfiUCbxvoza1e8yUBVojyWvYCrR5nLo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Estado de la aplicación
        let currentUser = null;
        let userFriends = [];
        let refreshInterval = null;
        let currentGuest = null;
        let friendsTableRendered = false;
        let roomSubscription = null;
        let currentRoomId = null;
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserSession();
            await loadUserFriends();
            await setupRoom();
            subscribeToRoomChanges();
            
            // Iniciar actualización automática cada 30 segundos
            startAutoRefresh();
        });
        
        // Verificar la sesión del usuario
        async function checkUserSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Error obteniendo sesión:', error);
                    showError('Error al verificar la sesión: ' + error.message);
                    updateDebugInfo('Error de sesión', error);
                    return;
                }
                
                if (!session) {
                    showError('No hay sesión activa. Redirigiendo al login...');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                currentUser = session.user;
                console.log('Usuario actual:', currentUser.id);
                updateDebugInfo('Usuario actual', currentUser);
                
                // Actualizar last_sign_in_at del usuario actual
                await updateUserLastSignIn();
            } catch (error) {
                console.error('Error inesperado:', error);
                showError('Error inesperado al verificar sesión: ' + error.message);
                updateDebugInfo('Error inesperado', error);
            }
        }
        
        // Configurar la sala del usuario
        async function setupRoom() {
            if (!currentUser) return;
            
            try {
                // Buscar si el usuario ya tiene una sala activa
                const { data: existingRoom, error: roomError } = await supabase
                    .from('rooms')
                    .select('*')
                    .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                    .eq('is_active', true)
                    .single();
                
                if (roomError && roomError.code !== 'PGRST116') {
                    console.error('Error buscando sala:', roomError);
                    return;
                }
                
                if (existingRoom) {
                    // El usuario ya está en una sala
                    currentRoomId = existingRoom.id;
                    
                    // Determinar quién es el otro usuario en la sala
                    const otherUserId = existingRoom.user1_id === currentUser.id 
                        ? existingRoom.user2_id 
                        : existingRoom.user1_id;
                    
                    if (otherUserId) {
                        // Cargar información del otro usuario
                        const { data: otherUser } = await supabase
                            .from('profiles')
                            .select('id, username, avatar_url')
                            .eq('id', otherUserId)
                            .single();
                        
                        if (otherUser) {
                            currentGuest = otherUser;
                            addGuestToRoom(otherUser);
                        }
                    }
                } else {
                    // Crear una nueva sala para el usuario
                    const { data: newRoom, error: createError } = await supabase
                        .from('rooms')
                        .insert([{ 
                            user1_id: currentUser.id, 
                            is_active: true 
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creando sala:', createError);
                        return;
                    }
                    
                    currentRoomId = newRoom.id;
                }
                
                updateDebugInfo('Sala configurada', { roomId: currentRoomId, guest: currentGuest });
            } catch (error) {
                console.error('Error configurando sala:', error);
                updateDebugInfo('Error configurando sala', error);
            }
        }
        
        // Suscribirse a cambios en la sala en tiempo real
        function subscribeToRoomChanges() {
            if (!currentRoomId) return;
            
            // Cancelar suscripción anterior si existe
            if (roomSubscription) {
                supabase.removeChannel(roomSubscription);
            }
            
            // Suscribirse a cambios en la sala actual
            roomSubscription = supabase
                .channel('room-changes')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'rooms',
                        filter: `id=eq.${currentRoomId}`
                    },
                    async (payload) => {
                        console.log('Cambio en sala recibido:', payload);
                        
                        // Actualizar la interfaz según los cambios
                        const room = payload.new;
                        
                        // Determinar quién es el otro usuario en la sala
                        const otherUserId = room.user1_id === currentUser.id 
                            ? room.user2_id 
                            : room.user1_id;
                        
                        if (otherUserId && !currentGuest) {
                            // Cargar información del otro usuario
                            const { data: otherUser } = await supabase
                                .from('profiles')
                                .select('id, username, avatar_url')
                                .eq('id', otherUserId)
                                .single();
                            
                            if (otherUser) {
                                currentGuest = otherUser;
                                addGuestToRoom(otherUser);
                            }
                        } else if (!otherUserId && currentGuest) {
                            // El otro usuario salió de la sala
                            currentGuest = null;
                            clearGuestFromRoom();
                        }
                    }
                )
                .subscribe();
        }
        
        // Actualizar last_sign_in_at del usuario actual
        async function updateUserLastSignIn() {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ last_sign_in_at: new Date().toISOString() })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Error actualizando last_sign_in_at:', error);
                }
            } catch (error) {
                console.error('Error inesperado actualizando last_sign_in_at:', error);
            }
        }
        
        // Cargar amigos del usuario
        async function loadUserFriends() {
            if (!currentUser) return;
            
            try {
                console.log('Cargando amigos para usuario:', currentUser.id);
                
                // Consulta directa a la tabla friends
                const { data: friends, error } = await supabase
                    .from('friends')
                    .select(`
                        *,
                        user1:profiles!user1_id(id, username, avatar_url, last_sign_in_at),
                        user2:profiles!user2_id(id, username, avatar_url, last_sign_in_at)
                    `)
                    .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);
                
                if (error) {
                    console.error('Error cargando amigos:', error);
                    
                    if (error.code === '42501' || error.message.includes('permission')) {
                        showError('Error de permisos: Necesitas habilitar políticas RLS en Supabase.');
                        updateDebugInfo('Error de políticas RLS', error);
                    } else {
                        showError('Error al cargar la lista de amigos: ' + error.message);
                        updateDebugInfo('Error cargando amigos', error);
                    }
                    
                    renderFriendsList(getSampleFriends());
                    return;
                }
                
                console.log('Amigos cargados:', friends);
                userFriends = friends || [];
                renderFriendsList(userFriends);
            } catch (error) {
                console.error('Error inesperado:', error);
                showError('Error inesperado al cargar amigos: ' + error.message);
                updateDebugInfo('Error inesperado', error);
                
                renderFriendsList(getSampleFriends());
            }
        }
        
        // Determinar si un usuario está en línea (últimos 2 minutos)
        function isUserOnline(lastSignInAt) {
            if (!lastSignInAt) return false;
            
            const lastSignInTime = new Date(lastSignInAt).getTime();
            const currentTime = new Date().getTime();
            const twoMinutesAgo = currentTime - (2 * 60 * 1000); // 2 minutos en milisegundos
            
            return lastSignInTime >= twoMinutesAgo;
        }
        
        // Datos de ejemplo para desarrollo cuando hay errores
        function getSampleFriends() {
            return [
                {
                    user1_id: currentUser.id,
                    user2_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                    user2: {
                        id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                        username: 'Amigo Ejemplo',
                        avatar_url: null,
                        last_sign_in_at: new Date().toISOString() // En línea
                    }
                },
                {
                    user1_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567891',
                    user2_id: currentUser.id,
                    user1: {
                        id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567891',
                        username: 'Otro Amigo',
                        avatar_url: null,
                        last_sign_in_at: new Date(Date.now() - 3 * 60 * 1000).toISOString() // Desconectado
                    }
                }
            ];
        }
        
        // Renderizar la lista de amigos - VERSIÓN CORREGIDA
        function renderFriendsList(friends) {
            const friendsContainer = document.getElementById('friends-container');
            
            // Si ya se renderizó la tabla, actualizarla en lugar de reemplazar
            if (friendsTableRendered) {
                updateFriendsTable(friends);
                return;
            }
            
            // Crear la tabla por primera vez
            const friendsTable = document.createElement('table');
            friendsTable.className = 'friends-table';
            friendsTable.id = 'friends-table';
            
            // Crear encabezado de la tabla
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Nombre</th>
                    <th>Estado</th>
                    <th>Invitar</th>
                </tr>
            `;
            friendsTable.appendChild(thead);
            
            // Crear cuerpo de la tabla
            const tbody = document.createElement('tbody');
            tbody.id = 'friends-tbody';
            
            if (friends.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px;">
                            No tienes amigos aún. ¡Agrega algunos para jugar juntos!
                        </td>
                    </tr>
                `;
            } else {
                renderFriendsRows(tbody, friends);
            }
            
            friendsTable.appendChild(tbody);
            
            // Eliminar el elemento de carga si existe
            const loadingElement = document.getElementById('friends-loading');
            if (loadingElement && loadingElement.parentNode === friendsContainer) {
                friendsContainer.removeChild(loadingElement);
            }
            
            // Agregar la tabla al contenedor
            friendsContainer.appendChild(friendsTable);
            friendsTableRendered = true;
        }
        
        // Renderizar filas de amigos
        function renderFriendsRows(tbody, friends) {
            friends.forEach(friend => {
                // Determinar qué usuario es el amigo (no el usuario actual)
                let friendProfile;
                if (friend.user1_id === currentUser.id) {
                    friendProfile = friend.user2 || { 
                        id: friend.user2_id, 
                        username: 'Usuario ' + friend.user2_id.substring(0, 8),
                        avatar_url: null,
                        last_sign_in_at: null
                    };
                } else {
                    friendProfile = friend.user1 || { 
                        id: friend.user1_id, 
                        username: 'Usuario ' + friend.user1_id.substring(0, 8),
                        avatar_url: null,
                        last_sign_in_at: null
                    };
                }
                
                const isOnline = isUserOnline(friendProfile.last_sign_in_at);
                const isAlreadyInRoom = currentGuest && currentGuest.id === friendProfile.id;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="friend-name">${friendProfile.username || 'Usuario'}</td>
                    <td class="friend-status">
                        <span class="status-indicator ${isOnline ? 'status-online-indicator' : 'status-offline-indicator'}"></span>
                        ${isOnline ? 'En línea' : 'Desconectado'}
                    </td>
                    <td>
                        <button class="invite-btn ${isOnline && !isAlreadyInRoom ? 'invite-online' : 'invite-offline'}" 
                                ${isOnline && !isAlreadyInRoom ? '' : 'disabled'}>
                            <i class="fas fa-plus"></i> 
                            ${isAlreadyInRoom ? 'En sala' : 'Invitar'}
                        </button>
                    </td>
                `;
                
                // Agregar evento al botón de invitar
                if (isOnline && !isAlreadyInRoom) {
                    const inviteBtn = row.querySelector('.invite-btn');
                    inviteBtn.addEventListener('click', () => sendInvitation(friendProfile));
                }
                
                tbody.appendChild(row);
            });
        }
        
        // Actualizar la tabla de amigos existente
        function updateFriendsTable(friends) {
            const tbody = document.getElementById('friends-tbody');
            if (!tbody) return;
            
            // Limpiar el cuerpo de la tabla
            tbody.innerHTML = '';
            
            // Volver a renderizar las filas
            if (friends.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px;">
                            No tienes amigos aún. ¡Agrega algunos para jugar juntos!
                        </td>
                    </tr>
                `;
            } else {
                renderFriendsRows(tbody, friends);
            }
        }
        
        // Enviar invitación a un amigo
        async function sendInvitation(friend) {
            try {
                // Simular envío de invitación
                const { value: accept } = await Swal.fire({
                    title: 'Enviar invitación',
                    html: `¿Quieres invitar a <strong>${friend.username}</strong> a la sala?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#43cea2',
                    cancelButtonColor: '#e74c3c',
                    confirmButtonText: 'Sí, invitar',
                    cancelButtonText: 'Cancelar'
                });
                
                if (accept) {
                    // Actualizar la sala para incluir al amigo invitado
                    const { error } = await supabase
                        .from('rooms')
                        .update({ 
                            user2_id: friend.id,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentRoomId);
                    
                    if (error) {
                        console.error('Error actualizando sala:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo enviar la invitación',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    // Actualizar la interfaz localmente
                    currentGuest = friend;
                    addGuestToRoom(friend);
                    
                    Swal.fire({
                        title: 'Invitación enviada',
                        html: `Esperando a <strong>${friend.username}</strong>...`,
                        icon: 'info',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recargar la lista de amigos para actualizar los botones
                    await loadUserFriends();
                }
            } catch (error) {
                console.error('Error enviando invitación:', error);
                showError('Error al enviar la invitación: ' + error.message);
                updateDebugInfo('Error invitación', error);
            }
        }
        
        // Añadir invitado a la sala
        function addGuestToRoom(guest) {
            const guestCard = document.getElementById('guest-user-card');
            if (guestCard) {
                guestCard.innerHTML = `
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="user-name">${guest.username}</h3>
                    <div class="user-status status-online">Conectado</div>
                    <p>Jugando contigo</p>
                `;
            }
        }
        
        // Limpiar invitado de la sala
        function clearGuestFromRoom() {
            const guestCard = document.getElementById('guest-user-card');
            if (guestCard) {
                guestCard.innerHTML = `
                    <div class="empty-room">
                        <div class="empty-room-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="empty-room-text">
                            Invita a un amigo para jugar juntos
                        </div>
                    </div>
                `;
            }
            
            // Recargar la lista de amigos para actualizar los botones
            loadUserFriends();
        }
        
        // Iniciar actualización automática
        function startAutoRefresh() {
            // Limpiar intervalo existente
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Actualizar cada 30 segundos
            refreshInterval = setInterval(async () => {
                console.log('Actualizando datos automáticamente...');
                await loadUserFriends();
            }, 30000); // 30 segundos
        }
        
        // Refrescar datos manualmente
        async function refreshData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const originalHtml = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            await loadUserFriends();
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalHtml;
            }, 1000);
        }
        
        // Mostrar información de la sala
        function showRoomInfo() {
            Swal.fire({
                title: 'Sala de Amigos',
                html: `
                    <div style="text-align: left; padding: 10px;">
                        <p style="margin-bottom: 15px;">Bienvenido a la sala de amigos, un espacio donde puedes:</p>
                        
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="margin-bottom: 8px;"><i class="fas fa-users" style="margin-right: 8px;"></i> Conectar con tus amigos</p>
                            <p style="margin-bottom: 8px;"><i class="fas fa-gamepad" style="margin-right: 8px;"></i> Jugar juntos</p>
                            <p><i class="fas fa-trophy" style="margin-right: 8px;"></i> Competir y ganar premios</p>
                        </div>
                        
                        <p>Los usuarios aparecen como "En línea" si han iniciado sesión en los últimos 2 minutos.</p>
                        <p>¡Invita a más amigos y diviértanse!</p>
                    </div>
                `,
                icon: 'info',
                iconColor: '#667eea',
                background: '#764ba2',
                color: '#ffffff',
                confirmButtonColor: '#43cea2',
                confirmButtonText: '¡Entendido!',
                width: '600px'
            });
        }
        
        // Mostrar error
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
            `;
        }
        
        // Actualizar información de depuración
        function updateDebugInfo(context, data) {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <strong>Contexto:</strong> ${context}<br>
                <strong>Hora:</strong> ${new Date().toLocaleTimeString()}<br>
                <strong>Datos:</strong><br> 
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }
        
        // Alternar visibilidad de información de depuración
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            const debugToggle = document.querySelector('.debug-toggle');
            
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
                debugToggle.textContent = 'Ocultar información de depuración';
            } else {
                debugInfo.style.display = 'none';
                debugToggle.textContent = 'Mostrar información de depuración';
            }
        }
    </script>
</body>
</html>